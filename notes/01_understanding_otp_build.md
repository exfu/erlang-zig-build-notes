# 01_understanding_otp.md

This document serves as a central point for understanding the journey of compiling Erlang/OTP with Zig. It consolidates the initial roadmap and provides more detailed insights for potential contributors.

**Introduction**

The goal of this project is to build Erlang/OTP (Open Telecom Platform) from scratch using only the Zig programming language as the build system. This means we aim to replace the traditional reliance on C compilers and Makefiles with a build process defined entirely in Zig.

This is an ambitious undertaking driven by the desire for a potentially cleaner, faster, and more auditable build process. The initial Minimum Viable Product (MVP) will target the Linux operating system.

**Challenges Ahead:**

* Erlang/OTP's core, especially the BEAM virtual machine (`erts`), is primarily written in C.
* The existing build system is complex, involving Autotools, Makefiles, and shell scripts.
* Erlang/OTP has dependencies on various system libraries and potentially external C libraries.
* Bootstrapping the Erlang compiler itself within a pure Zig environment presents a unique challenge.

**1. Understanding the Current Erlang/OTP Build System**

Before we can build Erlang/OTP with Zig, we need a solid understanding of how it's built traditionally. The key components of the standard build process include:

* **`configure` Scripts:** These scripts, often generated by Autotools, perform system checks (e.g., presence of libraries, compiler capabilities) and generate the Makefiles based on the environment. We need to understand what checks are crucial to replicate them in Zig.
* **Makefiles:** These files define the actual build rules: which C files to compile, with what flags, and how to link them into executables and libraries. Analyzing these will tell us the exact compilation units and linking steps required for each component.
* **Shell Scripts:** Various shell scripts are used for pre-processing, post-processing, and other build-related tasks. We'll need to identify their purpose and potentially reimplement their logic in Zig.
* **Erlang Compiler (`erlc`):** The Erlang compiler is part of OTP and is itself built from Erlang and some C code. Understanding its build process is critical for our bootstrapping strategy.

**Key Areas to Investigate:**

* **`erts` (Erlang Runtime System):** Focus on the C source files in `erts`, their compilation flags (e.g., include paths, optimization levels, preprocessor definitions), and the system libraries they link against (e.g., `libc`, `libm`, `libpthread`).
* **`kernel` and `stdlib`:** Understand how the Erlang source files (`.erl`) in these essential libraries are compiled. This will involve looking at how `erlc` is invoked during the build.
* **External Dependencies:** Identify any external C libraries that Erlang/OTP depends on (e.g., `zlib`, `openssl`, `ncurses`). We need to know how these are detected and linked.

**2. Leveraging the Zig Build System for Erlang/OTP**

Zig's build system, managed by the `build.zig` file, offers a way to define our build process in code. Here's how we plan to utilize it:

* **Translating C Compilation Units:** For each C source file in Erlang/OTP (primarily in `erts`), we'll create a corresponding compilation step in `build.zig`. We'll use Zig's `@cImport` to access C headers.
* **Handling Compilation Flags:** Compilation flags from the Makefiles will be translated into options within the Zig build steps (e.g., include paths via `addIncludePath`, optimization levels via `setOptimize`, preprocessor definitions via `define`).
* **Linking System Libraries:** We'll use Zig's linking features (e.g., `linkLibC()`, `linkSystemLibrary("pthread")`) to link against the necessary system libraries.
* **Managing External C Libraries:**
    * **MVP Strategy:** Initially, we might link against system-installed versions of external libraries.
        * **Long-Term Goal:** The ideal scenario is to find or create pure Zig implementations of these libraries.
        * **Implementing Erlang Compilation:** This will likely involve a bootstrapping process where we first build a minimal BEAM VM capable of running the Erlang compiler, and then use that to compile the remaining Erlang source files. This will be integrated as a step in `build.zig`.
        * **Replicating Configuration Checks:** The logic from the `configure` scripts will need to be reimplemented in `build.zig` using Zig's standard library for system introspection and conditional build logic.

        **Conceptual `build.zig` Snippet (Illustrative):**

        ```zig
        const std = @import("std");
        const Builder = std.build.Builder;

        pub fn build(b: *Builder) !void {
              const target = b.standardTargetOptions(.{});
                  const optimize = b.standardOptimizeOption(.{});

                      // Building the core BEAM VM (example for a single C file)
                          const beam_main = b.addExecutable(.{
                                    .name = "beam.smp",
                                            .root_source_file = .{ .path = "erts/main/main.c" },
                                                    .target = target,
                                                            .optimize = optimize,
                                                                });
                                                                    beam_main.addIncludePath(.{ .path = "erts/include" });
                                                                        beam_main.linkLibC();
                                                                            beam_main.linkSystemLibrary("pthread");

                                                                                // ... more build steps for other C files in erts ...

                                                                                    // Example of compiling Erlang code (will require bootstrapping)
                                                                                        // const erlc_executable = ...; // Path to our Erlang compiler
                                                                                            // const kernel_sources = b.addDirectory(.{ .path = "lib/kernel/src" });
                                                                                                // const compile_kernel = b.addSystemCommand(.{
                                                                                                      //     .name = "compile_kernel",
                                                                                                          //     .cwd = kernel_sources.path,
                                                                                                              //     .steps = &.{
                                                                                                                    //         .{ .command = &[_]const u8{ erlc_executable, "*.erl" } },
                                                                                                                        //     },
                                                                                                                            // });
                                                                                                                                // compile_kernel.dependOn(&beam_main.step);

                                                                                                                                    // ... more build steps for stdlib and other OTP applications ...
                                                                                                                                    }

                                                                                                                                    3. Building the Core BEAM VM with Zig
                                                                                                                                    The BEAM VM is the foundation. Building it with Zig involves:
                                                                                                                                     * Identifying Core C Source Files: We need to meticulously identify the C files in erts that are essential for a minimal, functional BEAM VM.
                                                                                                                                     * Creating Zig Build Steps: For each C file, we'll define a compilation step in build.zig using b.addExecutable (for the final BEAM executable) or b.addObject (for intermediate object files).
                                                                                                                                     * @cImport Usage: We'll use @cImport to bring in the necessary C header files from erts/include and other relevant directories. Manual Zig header definitions might be needed for complex C constructs.
                                                                                                                                     * Compilation Flag Translation: We'll map the compilation flags used in the original Makefiles to their equivalents in Zig's build system.
                                                                                                                                     * System Library Linking: We'll use linkLibC(), linkSystemLibrary("pthread"), linkSystemLibrary("m"), etc., to link against the required system libraries.
                                                                                                                                     * External C Library Handling (Initial): For libraries like zlib and openssl, our initial approach might be to link against the system-installed versions using linkSystemLibrary("z") and linkSystemLibrary("ssl").
                                                                                                                                    Illustrative build.zig Snippet for BEAM:
                                                                                                                                    const std = @import("std");
                                                                                                                                    const Builder = std.build.Builder;

                                                                                                                                    pub fn build(b: *Builder) !void {
                                                                                                                                          const target = b.standardTargetOptions(.{});
                                                                                                                                              const optimize = b.standardOptimizeOption(.{});

                                                                                                                                                  const erts_c_sources = &.{
                                                                                                                                                            "erts/main/main.c",
                                                                                                                                                                    "erts/emulator/beam/beam_main.c",
                                                                                                                                                                            "erts/emulator/beam/erl_vm.c",
                                                                                                                                                                                    // ... and many more ...
                                                                                                                                                                                        };

                                                                                                                                                                                            const beam_vm = b.addExecutable(.{
                                                                                                                                                                                                      .name = "beam.smp",
                                                                                                                                                                                                              .root_source_file = .{ .path = erts_c_sources[0] },
                                                                                                                                                                                                                      .sources = erts_c_sources,
                                                                                                                                                                                                                              .target = target,
                                                                                                                                                                                                                                      .optimize = optimize,
                                                                                                                                                                                                                                          });

                                                                                                                                                                                                                                              beam_vm.addIncludePath(.{ .path = "erts/include" });
                                                                                                                                                                                                                                                  beam_vm.addIncludePath(.{ .path = "erts/emulator/beam" });
                                                                                                                                                                                                                                                      // ... other necessary include paths ...

                                                                                                                                                                                                                                                          beam_vm.define("HAVE_CONFIG_H", "1"); // Example preprocessor definition

                                                                                                                                                                                                                                                              beam_vm.linkLibC();
                                                                                                                                                                                                                                                                  beam_vm.linkSystemLibrary("pthread");
                                                                                                                                                                                                                                                                      beam_vm.linkSystemLibrary("m");
                                                                                                                                                                                                                                                                          beam_vm.linkSystemLibrary("z"); // For zlib
                                                                                                                                                                                                                                                                              beam_vm.linkSystemLibrary("ssl"); // For openssl
                                                                                                                                                                                                                                                                                  // ... other system libraries as needed ...
                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                  4. Compiling Erlang Libraries with a Zig-Built Compiler
                                                                                                                                                                                                                                                                                  This is a crucial and potentially iterative step. Our strategy for compiling the Erlang source files in kernel, stdlib, etc., will likely involve:
                                                                                                                                                                                                                                                                                   * Building a Minimal BEAM VM: Ensure the BEAM VM built in the previous step is functional enough to potentially run the Erlang compiler.
                                                                                                                                                                                                                                                                                   * Bootstrapping erlc: We'll need to figure out the minimal set of Erlang source files required to build a basic erlc executable. This might involve an initial compilation step using a pre-existing Erlang installation (if feasible for bootstrapping) or a carefully crafted subset of the compiler's code.
                                                                                                                                                                                                                                                                                   * Integrating Compilation into build.zig: Once we have a working (even minimal) Erlang compiler (hopefully built by our Zig-built BEAM), we'll integrate its invocation into the build.zig file using std.process.exec. This will allow us to compile the remaining Erlang source files.
                                                                                                                                                                                                                                                                                  Conceptual build.zig Snippet for Erlang Compilation:
                                                                                                                                                                                                                                                                                  const std = @import("std");
                                                                                                                                                                                                                                                                                  const Builder = std.build.Builder;

                                                                                                                                                                                                                                                                                  pub fn build(b: *Builder) !void {
                                                                                                                                                                                                                                                                                        // ... (Build the minimal BEAM VM) ...

                                                                                                                                                                                                                                                                                            // Placeholder for obtaining the path to our (eventually Zig-built) erlc
                                                                                                                                                                                                                                                                                                const erlc_path = b.addSystemCommand(.{
                                                                                                                                                                                                                                                                                                          .name = "get_erlc_path",
                                                                                                                                                                                                                                                                                                                  .steps = &.{
                                                                                                                                                                                                                                                                                                                                .{ .command = &[_]const u8{ "echo", "./path/to/our/erlc" } }, // Replace with actual logic
                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                            }).getOutputExecutable();

                                                                                                                                                                                                                                                                                                                                                const kernel_sources = b.addDirectory(.{ .path = "lib/kernel/src" });
                                                                                                                                                                                                                                                                                                                                                    const kernel_output_dir = b.installArtifact(kernel_sources);

                                                                                                                                                                                                                                                                                                                                                        const compile_kernel = b.addSystemCommand(.{
                                                                                                                                                                                                                                                                                                                                                                  .name = "compile_kernel",
                                                                                                                                                                                                                                                                                                                                                                          .cwd = kernel_output_dir,
                                                                                                                                                                                                                                                                                                                                                                                  .steps = &.{
                                                                                                                                                                                                                                                                                                                                                                                                .{ .command = &[_]const u8{ erlc_path, "*.erl" } },
                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                compile_kernel.dependOn(&beam_vm.step);

                                                                                                                                                                                                                                                                                                                                                                                                                    // ... similar steps for stdlib and other applications ...
                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                    5. Handling Dependencies
                                                                                                                                                                                                                                                                                                                                                                                                                    Erlang/OTP depends on both system libraries and potentially external C libraries. Our strategies for managing these include:
                                                                                                                                                                                                                                                                                                                                                                                                                     * System Linking (Initial): For system libraries (e.g., libc, libpthread, libm) and common external C libraries (e.g., zlib, openssl), we'll initially rely on linking against the system-installed versions using Zig's linking features.
                                                                                                                                                                                                                                                                                                                                                                                                                     * Zig Alternatives (Long-Term): The ideal solution is to find or create pure Zig implementations of external C libraries. We'll explore Zig's package manager and the community for existing solutions.
                                                                                                                                                                                                                                                                                                                                                                                                                     * Direct C Compilation with Zig (Use Sparingly): As a last resort, if a Zig alternative isn't available and system linking isn't desired, Zig can compile C code directly. However, we aim to minimize the use of this to adhere to the "no C compiler" goal.
                                                                                                                                                                                                                                                                                                                                                                                                                    Conceptual build.zig Snippet for Dependencies:
                                                                                                                                                                                                                                                                                                                                                                                                                    const std = @import("std");
                                                                                                                                                                                                                                                                                                                                                                                                                    const Builder = std.build.Builder;

                                                                                                                                                                                                                                                                                                                                                                                                                    pub fn build(b: *Builder) !void {
                                                                                                                                                                                                                                                                                                                                                                                                                          const target = b.standardTargetOptions(.{});
                                                                                                                                                                                                                                                                                                                                                                                                                              const optimize = b.standardOptimizeOption(.{});

                                                                                                                                                                                                                                                                                                                                                                                                                                  const beam_vm = b.addExecutable(.{ /* ... */ });

                                                                                                                                                                                                                                                                                                                                                                                                                                      beam_vm.linkLibC();
                                                                                                                                                                                                                                                                                                                                                                                                                                          beam_vm.linkSystemLibrary("pthread");
                                                                                                                                                                                                                                                                                                                                                                                                                                              beam_vm.linkSystemLibrary("m");
                                                                                                                                                                                                                                                                                                                                                                                                                                                  beam_vm.linkSystemLibrary("z"); // System zlib
                                                                                                                                                                                                                                                                                                                                                                                                                                                      beam_vm.linkSystemLibrary("ssl"); // System openssl

                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Example of potentially using a Zig package for zlib in the future
                                                                                                                                                                                                                                                                                                                                                                                                                                                              // const zlib_package = b.dependency("zlib-zig", .{ .version = "some_version" });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // beam_vm.addPackage(zlib_package);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // ...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                      6. Testing and Future Directions
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Once we have a basic build, rigorous testing is essential. Our testing strategy will involve:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Running simple Erlang programs to verify core functionality.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Attempting to run Erlang/OTP's own test suites.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Gradually expanding testing as more components are built.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      Potential Future Directions:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Cross-compilation to other platforms using Zig's capabilities.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Performance analysis and optimization of the Zig-built Erlang/OTP.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Complete replacement of C dependencies with Zig alternatives.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Integration with Zig's package manager for easier distribution.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Community contributions and adoption.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      This document provides a foundational understanding of the project. As we progress, we will update this with more specific details and challenges encountered. Your contributions and insights are highly valued on this exciting journey!

                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                        })
                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                })
                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                            })
                                                                                                                                                  }
                                                                                                                                    }
                                                                                                              }
                                                                                                })
                          })
        }`

